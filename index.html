<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trinity Speaking Quiz â€“ YEAR 3</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
:root{
  --bg:#f4fbff;
  --card:#ffffff;
  --muted:#6b7280;
  --primary-1:#3b82f6;
  --primary-2:#0ea5e9;
  --accent:#f59e0b;
  --ok:#10b981;
  --bad:#ef4444;
  --glass: rgba(255,255,255,0.7);
  --radius:18px;
  --shadow: 0 10px 30px rgba(16,24,40,0.08);
  --child-shadow: 0 6px 18px rgba(16,24,40,0.06);
}
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@300;500;700&display=swap');
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#0f172a;background:
linear-gradient(180deg,#e6f6ff 0%, #f4fbff 60%);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.container{max-width:980px;margin:32px auto;padding:20px;}
.header{
  display:flex;align-items:center;gap:16px;padding:18px;border-radius:26px;
  background:linear-gradient(90deg,var(--primary-1),var(--primary-2));
  color:white;box-shadow:var(--shadow);
}
.brand{display:flex;align-items:center;gap:14px}
.logo{height:64px;width:64px;border-radius:12px;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-weight:700;font-family:'Fredoka One',sans-serif}
.title-wrap{line-height:1}
.app__title{margin:0;font-size:30px;font-weight:700}
.app__subtitle{margin:0;font-size:25px;opacity:.95}
.header-cta{margin-left:auto;text-align:right;font-size:22px;color:rgba(255,255,255,.95)}
.card{margin-top:18px;background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:var(--child-shadow)}
.topline{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.progress{flex:1;height:12px;background:#eef2f7;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 0 rgba(255,255,255,.6)}
.progress__bar{height:100%;width:0%;background:linear-gradient(90deg,var(--primary-1),var(--primary-2));transition:width .45s cubic-bezier(.2,.9,.2,1)}
.meta{min-width:210px;text-align:right;color:var(--muted);font-weight:600}
.card-body{display:grid;grid-template-columns:1fr 360px;gap:18px}
@media(max-width:940px){.card-body{grid-template-columns:1fr;}}
.quiz-area{min-height:260px;display:flex;flex-direction:column;gap:12px}
.question-box{display:flex;align-items:center;justify-content:flex-start;gap:12px}
.question-hidden{position: absolute !important; left: -9999px !important; width:1px !important; height:1px !important; overflow:hidden !important} /* visually hidden */
.speaker-btn{background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.88));border:0;padding:12px;border-radius:999px;font-size:25px;cursor:pointer;box-shadow:0 6px 18px rgba(10,20,40,0.05)}
.speaker-btn:hover{transform:translateY(-3px)}
.question-visual{flex:1}
.question-img{width:100%;border-radius:14px;box-shadow:0 8px 24px rgba(12,20,40,0.06)}
.choices{list-style:none;padding:0;margin:0;display:grid;gap:10px}
.choice-item{display:flex;align-items:center;gap:10px;background:#fbfdff;border-radius:12px;padding:10px;border:1px solid rgba(10,20,40,0.03)}
.choice-main{flex:1;display:flex;align-items:center;gap:10px}
.choice-text-btn{flex:1;text-align:left;border:0;background:transparent;padding:10px;border-radius:10px;font-weight:600;font-size:15px;cursor:pointer}
.choice-text-btn:hover{background:linear-gradient(90deg, rgba(59,130,246,0.06), rgba(14,165,233,0.03))}
.choice-speak{width:44px;height:44px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--primary-1),var(--primary-2));color:white;font-size:20px;cursor:pointer}
.choice-speak:active{transform:scale(.98)}
.controls{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.btn{border:0;padding:12px 16px;border-radius:14px;background:#f3f4f6;color:#0f172a;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(12,20,40,0.04)}
.btn--ghost{background:transparent;border:2px solid rgba(15,23,42,0.06)}
.btn--primary{background:linear-gradient(90deg,var(--primary-1),var(--primary-2));color:white}
.feedback{min-height:30px;margin-top:6px;font-weight:700;font-size:20px;display:flex;align-items:center;gap:8px;color:var(--muted)}
.feedback.ok{color:var(--ok)}
.feedback.bad{color:var(--bad)}
.sidebar{background:linear-gradient(180deg, rgba(250,250,255,0.8), rgba(245,250,255,0.6));padding:12px;border-radius:12px}
.score-big{font-size:20px;font-weight:800;color:var(--primary-1)}
.small{font-size:20px;color:var(--muted)}
.footer{margin-top:14px;text-align:center;color:var(--muted);font-size:22px}

/* Modal */
.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(6, 8, 15, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
    overflow: auto; /* permite scroll si el modal es mÃ¡s alto que la ventana */
    padding: 20px;  /* espacio para que no toque los bordes de la pantalla */
}

.modal {
    width: 90%;
    max-width: 900px;
    max-height: 90vh; /* que nunca supere el 90% de la altura de la pantalla */
    background: white;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 20px 60px rgba(2, 6, 23, 0.5);
    overflow-y: auto; /* scroll interno si el contenido excede el max-height */
}

.summary-list {
    max-height: 60vh; /* ajustable segÃºn prefieras, para que la lista tenga scroll interno */
    overflow: auto;
    padding: 8px;
    border-radius: 10px;
    border: 1px dashed rgba(15, 23, 42, 0.04);
}

/* small helpers */
.icon-speak{font-size:40px}
.hidden{display:none}

    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap; /* permite que se acomoden en pantallas pequeÃ±as */
      padding: 10px;
    }
    .logo-container img {
      max-width: 100px;  /* lÃ­mite de ancho */
      width: 100%;       /* hace que escale de forma responsive */
      height: auto;      /* mantiene proporciÃ³n */
    }


</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo-container">
    <img src="media/logo.png" alt="Logo principal">
    <img src="media/trinity.png" alt="Logo Trinity">
  </div>
      <div class="title-wrap">
        <h1 class="app__title">Trinity Speaking â€“ Year 3</h1>
        <div class="app__subtitle">Listen & choose the correct answer</div>
      </div>
    </div>
    <div class="header-cta">
    </div>
  </header>

  <section class="card" aria-live="polite">
    <div class="topline">
      <div class="progress" aria-label="Progress">
        <div class="progress__bar" id="progressBar"></div>
      </div>
      <div class="meta">
        <div id="counter">Question 1</div>
        <div id="score">Score: 0</div>
      </div>
    </div>

    <div class="card-body">
      <div class="quiz-area" id="quizArea">
        <!-- question hidden text + speaker -->
        <div class="question-box">
          <h2 id="questionText" class="question-hidden">â€”</h2>
          <button id="speakBtn" class="speaker-btn" title="Play question (click)"><span class="icon-speak">ðŸ”Š</span></button>
        </div>

        <!-- visualization area (image, etc.) -->
        <div id="visualWrap" class="question-visual"></div>

        <!-- choices -->
        <ul class="choices" id="choicesList" role="list"></ul>

        <div id="feedback" class="feedback" role="status" aria-live="polite"></div>

        <div class="controls">
          <button id="skipBtn" class="btn btn--ghost">Skip</button>
          <button id="restartBtn" class="btn btn--ghost hidden">Restart</button>
        </div>
      </div>

      <aside class="sidebar">
        <div class="score-big" id="scoreBig">Score: 0</div>
        <div class="small" style="margin-top:8px" id="questionsRemaining">Questions left: 0</div>
        <div style="margin-top:14px" class="small">Tip: Students must click the speaker to hear the question.</div>
      </aside>
    </div>

    <div class="footer">Tip: Only select the answers that correctly describe the question.</div>
  </section>
</div>

<!-- Modal for results summary & form -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <div class="modal-head">
      <h3 style="margin:0">Quiz summary</h3>
      <div>
        <button id="closeModal" class="btn btn--ghost">Close</button>
      </div>
    </div>

    <div class="summary-list" id="summaryList"></div>

    <label style="display:block;margin-top:10px;font-weight:700">Summary to send (editable):</label>
    <textarea class="summary-text" id="summaryText"></textarea>

    <form id="sendForm" action="https://formspree.io/f/mandldqw" method="POST" style="margin-top:12px">
      <input type="text" name="student_name" placeholder="Student's name" required style="padding:10px;border-radius:10px;border:1px solid #e6eef8;width:100%;box-sizing:border-box">
      <input type="hidden" name="summary" id="summaryHidden">
      <input type="hidden" name="score" id="scoreHidden">
      <div style="display:flex;gap:10px;margin-top:10px;justify-content:flex-end">
        <button type="submit" class="btn btn--primary">Send Result</button>
      </div>
    </form>
  </div>
</div>

<script>
/* =========================================================
   Original question set (kept as provided), minor JS
   enhancements added: choice-speaker buttons, modal result
   ========================================================= */

const questions = [
Â  {type:"text",question:"What's your name?",choices:["My name is Sarah.","I'm fine, thank you.","I'm 8 years old."],correct:[0], userAnswer: null}, Â 
Â  {type:"text",question:"How are you?",choices:["I'm 8 years old.","I great.","I'm fine, thank you."],correct:[2], userAnswer: null},
Â  {type:"text",question:"How old are you?",choices:["I'm fine, thank you.","I'm 8 years old.","It's cloudy."],correct:[1], userAnswer: null},
Â  {type:"text",question:"What's the weather like?",choices:["I'm fine.","I like watching TV.","It's sunny."],correct:[2], userAnswer: null},
Â  {type:"text",question:"What's the date today?",choices:["It's cloudy.","September ten.","It's Monday, September 15th."],correct:[2], userAnswer: null},
Â  {type:"text",question:"When's your birthday?",choices:["My birthday is on January 11th.","Happy birthday!","It May 20."],correct:[0], userAnswer: null},
Â  {type:"text",question:"Where do you live?",choices:["I live in Buenos Aires.","I am 10 years old.","Yes, I live."],correct:[0], userAnswer: null},
  {type:"text",question:"Do you live in a house or a flat?",choices:["I live in a house.","My house is big.","No, I don't."],correct:[0], userAnswer: null},
  {type:"text",question:"How do you go to school?",choices:["I go to school.","I go to school by car.","Yes, I do."],correct:[1], userAnswer: null},
Â  {type:"text",question:"What's your favourite colour?",choices:["My favourite colour is blue.","My colour favourite is yellow","I'm fine."],correct:[0], userAnswer: null},
  {type:"text",question:"What do you do in your free time?",choices:["I go to school.","I play video games and read books.","I study."],correct:[1], userAnswer: null},
Â  {type:"text",question:"Do you have any pets?",choices:["Yes, I do.","No, I can't.","Yes, pets."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What's your favourite food?",choices:["Yes, I am.","My favourite food is pizza.","Favourite pizza food"],correct:[1], userAnswer: null},
Â  {type:"text",question:"Can you swim?",choices:["Yes, I can.","I am swimming.","I like swimming."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What is your favourite sport?",choices:["No, I don't.","I like playing sports.", "My favourite sport is football."],correct:[2], userAnswer: null},
Â  {type:"text",question:"Do you like ice cream?",choices:["Yes, I do.","No, I can't.","I'm hungry."],correct:[0], userAnswer: null},
Â  {type:"text",question:"Can you ride a bike?",choices:["Yes, I can.","I like pizza.","I'm fine."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What is your favourite school subject?",choices:["My favourite subject is Language.","I am 9 years old.","I like cats."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What do you usually eat for breakfast?",choices:["I usually eat pizza.","Pizza.","I usually eat cookies."],correct:[2], userAnswer: null},
  {type:"text",question:"What time does school finish?",choices:["I go to school.","I finish.","At 4 o'clock in the afternoon."],correct:[2], userAnswer: null},
Â  {type:"text",question:"Do you like reading books?",choices:["Yes, I do.","I have a dog.","I like swimming."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What's your father's job?",choices:["It's great!","It's five o'clock.","He's a dentist."],correct:[2], userAnswer: null},
Â  {type:"text",question:"Do you play any musical instrument?",choices:["Yes, I do.","No, thank you.","I am 8."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What do you usually do in the evening?",choices:["I get up in the morning.","I have a shower and watch TV.","I like cats."],correct:[1], userAnswer: null},
Â  {type:"text",question:"Can you speak English?",choices:["No, I don't.","I live in Paris.","Yes, I can."],correct:[2], userAnswer: null},
Â  {type:"text",question:"What time do you go to bed?",choices:["Yes, I do.","I go to bed at 10 o'clock.","I have dinner."],correct:[1], userAnswer: null},
Â  {type:"text",question:"Can your dad cook?",choices:["Yes, I do.","Yes, he can.","No, I don't."],correct:[1], userAnswer: null},
Â  {type:"text",question:"What do you do in the morning?",choices:["I get up and I brush my teeth.","I go to bed.","I go home."],correct:[0], userAnswer: null},
Â  {type:"text",question:"Do you like swimming?",choices:["Yes, I do.","I can't.","I swim."],correct:[0], userAnswer: null},
Â  {type:"text",question:"What time do you usually get up?",choices:["I usually get up at 7 o'clock.","I like cats.","I'm happy."],correct:[0], userAnswer: null},
Â  {type:"text",question:"Imagine you are in a restaurant, what would you like to eat?",choices:["Yes, I would.","I like sushi.","I'd like to eat a burger."],correct:[2], userAnswer: null},
Â  // 10 preguntas con imagen y 5 correctas
Â  {type:"image",question:"Look at the picture. Choose 5 correct sentences.",image:"media/img1.png",
Â  Â choices:["There is a clock.","The weather is partly cloudy.","The children are playing.","They are in the Art class.","There is chairs.","They are in a classroom.","The birds are flying.","They are pasting, cutting and colouring pictures.","There are some apples.", "The dad is cooking."],
Â  Â correct:[0,1,3,5,7], userAnswer: []},
Â  {type:"image",question:"Look at the picture. Choose 5 correct sentences.",image:"media/img2.png",
Â  Â choices:["It's sunny.","The girl is skipping the rope.","The boy is playing with a car.","They are playing football.","The bird is flying.","It's cloudy.","The ball is pink.","The girl is reading.","The trees are red.","He is cooking."],
Â  Â correct:[0,1,2,3,4], userAnswer: []},
Â  {type:"image",question:"Look at the picture. Choose 5 correct sentences.",image:"media/img3.png",
Â  Â choices:["The girl is on the tree.","The dog is jumping.","There are 4 apples.","There is any apples.","The dog is playing with the boy.","She is singing.","The boy is sleeping.","She is sleeping.","She is reading a book.","It's rainy."],
Â  Â correct:[0,2,4,6,8], userAnswer: []},
Â  {type:"image",question:"Look at the picture. Choose 5 correct sentences.",image:"media/img4.png",
Â  Â choices:["There is some eggs.","There are some eggs.","There isn't any sugar.","There is some sugar.","There aren't any water.","There isn't some water.","There isn't any water.","There isn't any spinach.","There is some spinach.","There aren't any mushrooms."],
Â  Â correct:[1,3,6,8,9], userAnswer: []},


Â  {type:"image",question:"Look at the picture. What are their jobs? Choose 5 sentences.",image:"media/img6.png",
Â  Â choices:["He is a football player.","She is a painter.","My father is a teacher.","Astronaut and fireman.","They are dentists.","She is an astronaut.","They are doctors.","She is a chef.","He's an actor.", "She's a doctor."],
Â  Â correct:[0,1,5,7,9], userAnswer: []},

Â  

Â  {type:"text",question:"Great job. Have a nice day, goodbye!",choices:["Good bye!","Hello!","I'm happy."],correct:[0], userAnswer: null},
];

let currentIndex = 0, score = 0, currentQuestion = null;
const questionText = document.getElementById("questionText");
const visualWrap = document.getElementById("visualWrap");
const choicesList = document.getElementById("choicesList");
const feedback = document.getElementById("feedback");
const counter = document.getElementById("counter");
const scoreDisplay = document.getElementById("score");
const scoreBig = document.getElementById("scoreBig");
const progressBar = document.getElementById("progressBar");
const restartBtn = document.getElementById("restartBtn");
const skipBtn = document.getElementById("skipBtn");
const speakBtn = document.getElementById("speakBtn");
const questionsRemaining = document.getElementById("questionsRemaining");

// For results summary
const modalBackdrop = document.getElementById("modalBackdrop");
const summaryList = document.getElementById("summaryList");
const summaryText = document.getElementById("summaryText");
const summaryHidden = document.getElementById("summaryHidden");
const scoreHidden = document.getElementById("scoreHidden");
const sendForm = document.getElementById("sendForm");
const closeModal = document.getElementById("closeModal");
const downloadBtn = document.getElementById("downloadBtn");

// Keep track of user answers to generate summary
const userAnswers = []; // each entry: {selected: [indexes], correct:[indexes], type, qText}

function setProgress(){
  progressBar.style.width = `${(currentIndex/questions.length)*100}%`;
  counter.textContent = `Question ${Math.min(currentIndex+1, questions.length)} of ${questions.length}`;
  scoreDisplay.textContent = `Score: ${score}`;
  scoreBig.textContent = `Score: ${score}`;
  questionsRemaining.textContent = `Questions left: ${Math.max(questions.length - currentIndex,0)}`;
}

function clearVisuals(){
  visualWrap.innerHTML = "";
  choicesList.innerHTML = "";
  feedback.textContent = "";
  feedback.className = "feedback";
  // stop any speech
  if(window.speechSynthesis) speechSynthesis.cancel();
}

// Load question but **do not render the question text** visually (hidden). Only speaker plays it.
function loadQuestion(){
  clearVisuals();
  if(currentIndex >= questions.length){
    showResults();
    return;
  }
  currentQuestion = questions[currentIndex];
  // set hidden text (kept in DOM in questionText but visually hidden)
  questionText.textContent = currentQuestion.question;
  setProgress();

  // Visual: if image, show image
  if(currentQuestion.type === "image"){
    const img = document.createElement("img");
    img.src = currentQuestion.image;
    img.alt = "Question image";
    img.className = "question-img";
    visualWrap.appendChild(img);

    // render checkboxes + speak per option
    currentQuestion.choices.forEach((choice, i) => {
      const li = document.createElement("li");
      li.className = "choice-item";
      // main label with checkbox and text
      const main = document.createElement("div");
      main.className = "choice-main";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = i;
      cb.id = `cb-${currentIndex}-${i}`;
      cb.style.marginLeft = "6px";
      cb.style.marginRight = "8px";

      const labelBtn = document.createElement("button");
      labelBtn.type = "button";
      labelBtn.className = "choice-text-btn";
      labelBtn.textContent = choice;
      // clicking labelBtn toggles checkbox (for easier use on touch)
      labelBtn.addEventListener("click", () => {
        cb.checked = !cb.checked;
      });

      main.appendChild(cb);
      main.appendChild(labelBtn);

      // speaker for the choice
      const speakChoice = document.createElement("button");
      speakChoice.className = "choice-speak";
      speakChoice.title = "Play option";
      speakChoice.innerHTML = "ðŸ”Š";
      speakChoice.addEventListener("click", (e) => {
        e.stopPropagation();
        playText(choice);
      });

      li.appendChild(main);
      li.appendChild(speakChoice);
      choicesList.appendChild(li);
    });

    const btnCheck = document.createElement("button");
    btnCheck.className = "btn";
    btnCheck.textContent = "Check Answer";
    btnCheck.addEventListener("click", checkImageAnswer);
    choicesList.appendChild(btnCheck);

  } else {
    // text question: no visible question text, but keep image area empty
    visualWrap.innerHTML = "";

    // for each choice, show button + speak
    currentQuestion.choices.forEach((choice, i) => {
      const li = document.createElement("li");
      li.className = "choice-item";

      const main = document.createElement("div");
      main.className = "choice-main";

      const btn = document.createElement("button");
      btn.className = "choice-text-btn";
      btn.textContent = choice;
      btn.setAttribute("aria-pressed","false");
      btn.addEventListener("click", () => {
        checkTextAnswer(i, btn);
      });

      main.appendChild(btn);

      const speakChoice = document.createElement("button");
      speakChoice.className = "choice-speak";
      speakChoice.title = "Play option";
      speakChoice.innerHTML = "ðŸ”Š";
      speakChoice.addEventListener("click", (e) => {
        e.stopPropagation();
        playText(choice);
      });

      li.appendChild(main);
      li.appendChild(speakChoice);
      choicesList.appendChild(li);
    });
  }
}

// play a text using speechSynthesis (British English preferred)
let voices = [];
function setVoices(){
  voices = speechSynthesis.getVoices();
}
speechSynthesis.onvoiceschanged = setVoices;
setVoices();

function playText(text){
  if(window.speechSynthesis) speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-GB";
  u.rate = 0.75;
  u.pitch = 1;
  // pick en-GB if possible
  const brit = voices.find(v => v.lang && v.lang.startsWith("en-GB"));
  if(brit) u.voice = brit;
  speechSynthesis.speak(u);
}

// Speak full question when speakBtn clicked
speakBtn.addEventListener("click", () => {
  if(!currentQuestion) return;
  playText(currentQuestion.question);
});

// ------------------ answer checkers -------------------
function checkTextAnswer(i, btn){
  const isCorrect = currentQuestion.correct.includes(i);
  // disable all choice buttons
  const allBtns = choicesList.querySelectorAll(".choice-text-btn");
  allBtns.forEach(b => b.disabled = true);
  // result visual feedback
  if(isCorrect){
    btn.style.background = "linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06))";
    feedback.textContent = "Correct!";
    feedback.className = "feedback ok";
    score++;
  } else {
    btn.style.background = "linear-gradient(90deg, rgba(239,68,68,0.08), rgba(239,68,68,0.04))";
    feedback.textContent = "Wrong answer!";
    feedback.className = "feedback bad";
  }

  // record user answer
  userAnswers.push({
    type: currentQuestion.type,
    qText: currentQuestion.question,
    selected: [i],
    correct: currentQuestion.correct.slice(),
    selectedText: [currentQuestion.choices[i]],
  });

  setProgress();
  // proceed after short delay
  setTimeout(()=>{ currentIndex++; loadQuestion(); }, 1000);
}

function checkImageAnswer(){
  const checkboxes = choicesList.querySelectorAll('input[type="checkbox"]');
  const selected = [];
  checkboxes.forEach(cb => { if(cb.checked) selected.push(parseInt(cb.value)); });
  const correct = currentQuestion.correct.slice();
  // check exact match (same elements, order doesn't matter)
  const allCorrect = selected.length === correct.length && selected.every(v => correct.includes(v));
  if(allCorrect){
    feedback.textContent = "Correct!";
    feedback.className = "feedback ok";
    score++;
  } else {
    feedback.textContent = "Wrong answer!";
    feedback.className = "feedback bad";
  }

  // disable inputs
  checkboxes.forEach(cb => cb.disabled = true);
  const btnCheck = choicesList.querySelector("button");
  if(btnCheck) btnCheck.disabled = true;

  // store user answer selection texts
  const selTexts = selected.map(i => currentQuestion.choices[i]);
  userAnswers.push({
    type: currentQuestion.type,
    qText: currentQuestion.question,
    selected: selected.slice(),
    correct: correct.slice(),
    selectedText: selTexts
  });

  setProgress();
  setTimeout(()=>{ currentIndex++; loadQuestion(); }, 1200);
}

// ------------------ Results and Modal -------------------
function showResults(){
  // prepare summary
  // compute per-question correctness for summary display
  const summary = [];
  for(let i=0;i<userAnswers.length;i++){
    const ua = userAnswers[i];
    const correct = ua.correct.slice();
    let isCorrect = false;
    if(ua.type === "image"){
      isCorrect = ua.selected.length === correct.length && ua.selected.every(v => correct.includes(v));
    } else {
      isCorrect = ua.selected.length === correct.length && ua.selected.every(v => correct.includes(v));
    }
    summary.push({...ua, isCorrect});
  }

  // build summary html
  summaryList.innerHTML = "";
  summary.forEach((s, idx) => {
    const item = document.createElement("div");
    item.className = "summary-item";
    const left = document.createElement("div");
    left.className = "left";
    const qtitle = document.createElement("div");
    qtitle.style.fontWeight = 600;
    qtitle.style.marginBottom = "6px";
    qtitle.textContent = `Q${idx+1}: ${s.qText}`;
    left.appendChild(qtitle);

    const sel = document.createElement("div");
    sel.className = "small";
    if(s.selectedText && s.selectedText.length){
      sel.innerHTML = `<strong>Selected:</strong> ${s.selectedText.join(" â€” ")}`;
    } else sel.innerHTML = `<strong>Selected:</strong> (no selection)`;
    left.appendChild(sel);

    const corrList = s.correct.map(i => currentIndex>0 ? (questions[idx].choices ? questions[idx].choices[i] : '') : '').filter(Boolean);
    // but better display correct texts from the source question by matching qText
    // find the original question in questions array to get its choices
    const orig = questions.find(q => q.question === s.qText);
    const correctTexts = (orig && orig.choices) ? s.correct.map(i => orig.choices[i]) : s.correct.map(i => `#${i}`);
    const corr = document.createElement("div");
    corr.className = "small";
    corr.innerHTML = `<strong>Correct:</strong> ${correctTexts.join(" â€” ")}`;
    left.appendChild(corr);

    item.appendChild(left);

    const tag = document.createElement("div");
    tag.style.textAlign = "right";
    const span = document.createElement("span");
    span.className = "tag " + (s.isCorrect ? "ok" : "bad");
    span.textContent = s.isCorrect ? "Correct" : "Incorrect";
    tag.appendChild(span);
    item.appendChild(tag);

    summaryList.appendChild(item);
  });

  // prepare textual summary to send
  let summaryStr = `Quiz summary - Score: ${score} / ${questions.length}\n\n`;
  summary.forEach((s, idx) => {
    summaryStr += `Q${idx+1}: ${s.qText}\n`;
    summaryStr += `  Selected: ${s.selectedText && s.selectedText.length ? s.selectedText.join(" | ") : "(none)"}\n`;
    const orig = questions.find(q => q.question === s.qText);
    const correctTexts = (orig && orig.choices) ? s.correct.map(i => orig.choices[i]) : s.correct;
    summaryStr += `  Correct: ${correctTexts.join(" | ")}\n`;
    summaryStr += `  Result: ${s.isCorrect ? "Correct" : "Incorrect"}\n\n`;
  });

  summaryText.value = summaryStr;
  summaryHidden.value = summaryStr;
  scoreHidden.value = `${score} / ${questions.length}`;

  // show modal
  modalBackdrop.style.display = "flex";
  modalBackdrop.setAttribute("aria-hidden","false");
  // ensure form sends current summary on submit (hidden input updated on submit too)
  sendForm.addEventListener("submit", () => {
    summaryHidden.value = summaryText.value;
    scoreHidden.value = `${score} / ${questions.length}`;
  }, {once:true});
}

// close modal
closeModal.addEventListener("click", () => {
  modalBackdrop.style.display = "none";
  modalBackdrop.setAttribute("aria-hidden","true");
});


// restart and skip
restartBtn.addEventListener("click", ()=> {
  currentIndex = 0; score = 0; userAnswers.length = 0;
  restartBtn.classList.add("hidden");
  skipBtn.classList.remove("hidden");
  setProgress();
  loadQuestion();
});
skipBtn.addEventListener("click", ()=> {
  // record no selection for skipped question
  userAnswers.push({
    type: currentQuestion.type,
    qText: currentQuestion.question,
    selected: [],
    correct: currentQuestion.correct.slice(),
    selectedText: []
  });
  currentIndex++; loadQuestion();
});

// initial voices setup
setVoices();

// start
setProgress();
loadQuestion();

// When quiz finished, show modal (we call showResults internally)
function showResultsWrapper(){
  // prevent duplicate if modal already visible
  showResults();
  restartBtn.classList.remove("hidden");
  skipBtn.classList.add("hidden");
}

// Replace original showResults call within loadQuestion end-case
// Modify loadQuestion to call showResultsWrapper when done
// (already handled: loadQuestion calls showResults which opens modal)
// but ensure restart button appears
// To make sure, override showResults in this scope:
const origShowResults = showResults;
showResults = function(){
  origShowResults();
  restartBtn.classList.remove("hidden");
  skipBtn.classList.add("hidden");
};
</script>
</body>
</html>
